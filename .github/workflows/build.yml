name: Build PS2 ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: ps2dev/ps2dev:latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install genisoimage
      run: apk add --no-cache genisoimage cdrkit || apt-get install -y genisoimage || true

    - name: Verify toolchain
      run: ee-gcc --version

    - name: Compile ELF
      run: |
        make clean || true
        make
        ls -lh CaptainTsubasa2.elf

    - name: Build ISO
      run: |
        mkdir -p iso_staging
        cp CaptainTsubasa2.elf iso_staging/CPTSUBASA.ELF
        cp SYSTEM.CNF iso_staging/
        genisoimage -o CaptainTsubasa2.iso -V "CAPTTSUBASA2" -publisher "Fan-Made" iso_staging/
        ls -lh CaptainTsubasa2.iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: CaptainTsubasa2-PS2-ISO
        path: CaptainTsubasa2.iso
        retention-days: 90
